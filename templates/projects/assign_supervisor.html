<!-- File: templates/projects/assign_supervisor.html - ENHANCED VERSION -->

{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.supervisor-card {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.supervisor-card:hover {
    border-color: #5568FE;
    box-shadow: 0 4px 12px rgba(85, 104, 254, 0.15);
    transform: translateY(-2px);
}

.supervisor-card.selected {
    border-color: #5568FE;
    background: #F6F8FB;
}

.supervisor-card.unavailable {
    opacity: 0.6;
    cursor: not-allowed;
}

.supervisor-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    font-weight: 600;
}

.workload-bar {
    height: 24px;
    background: #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

.workload-fill {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: white;
    transition: width 0.3s ease;
}

.workload-low { background: #10B981; }
.workload-medium { background: #F59E0B; }
.workload-high { background: #EF4444; }

.project-info-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.info-note {
    background: #EFF6FF;
    border-left: 4px solid #3B82F6;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 24px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class='bx bx-user-check'></i> Assign Supervisor</h2>
                    <p class="text-muted mb-0">Select a supervisor for this project</p>
                </div>
                <a href="{% url 'projects:all_projects' %}" class="btn btn-secondary">
                    <i class='bx bx-arrow-back'></i> Back
                </a>
            </div>

            <!-- Project Information Banner -->
            <div class="project-info-banner">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-2">{{ project.title }}</h4>
                        <p class="mb-2 opacity-75">
                            <i class='bx bx-user'></i> Student: {{ project.student.display_name }} ({{ project.student.user_id }})
                        </p>
                        <p class="mb-0 opacity-75">
                            <i class='bx bx-code-alt'></i> Technologies: {{ project.programming_languages }}
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="badge bg-light text-dark mb-2" style="font-size: 14px;">
                            Batch {{ project.batch_year }}
                        </div>
                        <br>
                        <span class="badge bg-success" style="font-size: 14px;">
                            {{ project.get_status_display }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Important Note -->
            <div class="info-note">
                <h6 class="mb-2"><i class='bx bx-info-circle'></i> Automatic Group Assignment</h6>
                <p class="mb-0">
                    When you assign a supervisor to this project, the student will be <strong>automatically added to the supervisor's group</strong> for Batch {{ project.batch_year }}. 
                    If no suitable group exists, a new group will be created automatically.
                </p>
            </div>

            <!-- Supervisor Selection Form -->
            <form method="post" id="supervisorForm">
                {% csrf_token %}
                
                <div class="card modern-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class='bx bx-users'></i> Available Supervisors
                            <small class="text-muted">({{ supervisors|length }} supervisors)</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <input type="hidden" name="supervisor_id" id="supervisor_id" required>
                        
                        <div id="supervisorList">
                            {% for supervisor in supervisors %}
                            <div class="supervisor-card {% if not supervisor.is_available %}unavailable{% endif %}" 
                                 data-supervisor-id="{{ supervisor.id }}"
                                 onclick="{% if supervisor.is_available %}selectSupervisor({{ supervisor.id }}){% else %}return false;{% endif %}">
                                <div class="row align-items-center">
                                    <!-- Avatar & Basic Info -->
                                    <div class="col-md-3">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="supervisor-avatar">
                                                {{ supervisor.display_name|slice:":2"|upper }}
                                            </div>
                                            <div>
                                                <h6 class="mb-1">{{ supervisor.display_name }}</h6>
                                                <small class="text-muted">{{ supervisor.department|default:"No Department" }}</small>
                                                {% if not supervisor.is_available %}
                                                <br><span class="badge bg-danger">Full Capacity</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Workload Info -->
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-1">
                                            Current Workload: {{ supervisor.supervised_count }} students
                                        </small>
                                        <div class="workload-bar">
                                            <div class="workload-fill workload-{% if supervisor.workload_percentage < 50 %}low{% elif supervisor.workload_percentage < 80 %}medium{% else %}high{% endif %}" 
                                                 style="width: {{ supervisor.workload_percentage }}%">
                                                {{ supervisor.workload_percentage }}%
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            Groups: {{ supervisor.groups_count }} | 
                                            Capacity: {{ supervisor.current_load }}/{{ supervisor.total_capacity }}
                                        </small>
                                    </div>

                                    <!-- Current Students -->
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-2">Current Students:</small>
                                        {% if supervisor.current_students %}
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for student in supervisor.current_students %}
                                            <span class="badge bg-secondary" style="font-size: 11px;">
                                                {{ student.display_name|truncatechars:15 }}
                                            </span>
                                            {% endfor %}
                                            {% if supervisor.supervised_count > 5 %}
                                            <span class="badge bg-secondary" style="font-size: 11px;">
                                                +{{ supervisor.supervised_count|add:"-5" }} more
                                            </span>
                                            {% endif %}
                                        </div>
                                        {% else %}
                                        <span class="text-muted">No students yet</span>
                                        {% endif %}
                                    </div>

                                    <!-- Selection Indicator -->
                                    <div class="col-md-1 text-center">
                                        <i class='bx bx-check-circle selection-icon' style="font-size: 32px; color: #5568FE; display: none;"></i>
                                        {% if not supervisor.is_available %}
                                        <i class='bx bx-x-circle' style="font-size: 32px; color: #EF4444;"></i>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-5">
                                <i class='bx bx-user-x' style="font-size: 4rem; color: #d1d5db;"></i>
                                <h5 class="mt-3 text-muted">No Supervisors Available</h5>
                                <p class="text-muted">Please add supervisors to the system first.</p>
                            </div>
                            {% endfor %}
                        </div>

                        {% if supervisors %}
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div id="selectionMessage" class="text-muted" style="display: none;">
                                <i class='bx bx-check-circle'></i> 
                                <span id="selectedSupervisorName"></span> selected
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg" id="assignButton" disabled>
                                <i class='bx bx-user-check'></i> Assign Supervisor & Create/Join Group
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </form>

            <!-- Legend -->
            <div class="card modern-card mt-4">
                <div class="card-body">
                    <h6 class="mb-3">Workload Legend:</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 30px; height: 20px; background: #10B981; border-radius: 4px;"></div>
                                <span><strong>Low</strong> (0-50%) - Available</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 30px; height: 20px; background: #F59E0B; border-radius: 4px;"></div>
                                <span><strong>Medium</strong> (50-80%) - Moderate load</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 30px; height: 20px; background: #EF4444; border-radius: 4px;"></div>
                                <span><strong>High</strong> (80%+) - Near capacity</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedSupervisorId = null;

function selectSupervisor(supervisorId) {
    // Remove selection from all cards
    document.querySelectorAll('.supervisor-card').forEach(card => {
        card.classList.remove('selected');
        card.querySelector('.selection-icon').style.display = 'none';
    });
    
    // Select the clicked card
    const selectedCard = document.querySelector(`[data-supervisor-id="${supervisorId}"]`);
    if (selectedCard && !selectedCard.classList.contains('unavailable')) {
        selectedCard.classList.add('selected');
        selectedCard.querySelector('.selection-icon').style.display = 'block';
        
        // Update form
        document.getElementById('supervisor_id').value = supervisorId;
        selectedSupervisorId = supervisorId;
        
        // Show selection message
        const supervisorName = selectedCard.querySelector('h6').textContent;
        document.getElementById('selectedSupervisorName').textContent = supervisorName;
        document.getElementById('selectionMessage').style.display = 'block';
        
        // Enable submit button
        document.getElementById('assignButton').disabled = false;
    }
}

// Form validation
document.getElementById('supervisorForm').addEventListener('submit', function(e) {
    if (!selectedSupervisorId) {
        e.preventDefault();
        alert('Please select a supervisor');
        return false;
    }
    
    // Confirm assignment
    const confirmed = confirm(
        'This will:\n\n' +
        '1. Assign the supervisor to this project\n' +
        '2. Automatically add the student to the supervisor\'s group\n' +
        '3. Create a new group if needed\n\n' +
        'Are you sure you want to proceed?'
    );
    
    if (!confirmed) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}