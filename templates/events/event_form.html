{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit Event{% else %}Create Event{% endif %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .form-group {
        margin-bottom: 1.5rem;
    }
    .datetime-input {
        max-width: 300px;
    }
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-plus"></i>
                        {% if form.instance.pk %}Edit Event{% else %}Create Event{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Date Validation Warning -->
                    <div class="alert alert-warning mb-4">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Important:</strong> Cannot schedule events in the past. Please select future dates and times.
                    </div>
                    
                    <form method="post" id="eventForm">
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <div class="form-section mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-info-circle"></i> Basic Information</h5>
                            <div class="row">
                                <div class="col-md-12">
                                    {{ form.title|as_crispy_field }}
                                </div>
                                <div class="col-md-12">
                                    {{ form.description|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.event_type|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Date & Time -->
                        <div class="form-section mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-clock"></i> Date & Time</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="datetime-input">
                                        {{ form.start_datetime|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="datetime-input">
                                        {{ form.end_datetime|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-check">
                                        {{ form.all_day|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Location -->
                        <div class="form-section mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-map-marker-alt"></i> Location</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.location|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.virtual_link|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Participants -->
                        <div class="form-section mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-users"></i> Participants</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.batch_year|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.group|as_crispy_field }}
                                </div>
                                <div class="col-md-12">
                                    {{ form.organizer|as_crispy_field }}
                                </div>
                                <div class="col-md-12">
                                    {{ form.participants|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Settings -->
                        <div class="form-section mb-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-cog"></i> Settings</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.priority|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.is_mandatory|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.send_reminders|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    {{ form.reminder_hours_before|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Save Event
                            </button>
                            <a href="{% url 'events:event_list' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum datetime to current time
    const now = new Date();
    const timezoneOffset = now.getTimezoneOffset() * 60000;
    const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
    
    // Set min attribute for datetime inputs
    const startInput = document.querySelector('#id_start_datetime');
    const endInput = document.querySelector('#id_end_datetime');
    
    if (startInput) {
        startInput.min = localISOTime;
    }
    if (endInput) {
        endInput.min = localISOTime;
    }
    
    // Form validation
    const form = document.getElementById('eventForm');
    form.addEventListener('submit', function(e) {
        const startValue = startInput ? startInput.value : null;
        const endValue = endInput ? endInput.value : null;
        
        if (startValue && endValue) {
            const startDate = new Date(startValue);
            const endDate = new Date(endValue);
            const currentDate = new Date();
            
            // Check if dates are in the past
            if (startDate < currentDate) {
                e.preventDefault();
                alert('Cannot schedule events in the past. Please select a future date and time.');
                startInput.focus();
                return false;
            }
            
            // Check if end is before start
            if (endDate <= startDate) {
                e.preventDefault();
                alert('End time must be after start time.');
                endInput.focus();
                return false;
            }
        }
    });
});
</script>
{% endblock %}