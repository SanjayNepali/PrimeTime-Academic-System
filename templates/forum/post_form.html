<!-- File: templates/forum/post_form.html -->

{% extends 'base.html' %}
{% load static %}

{% block title %}{% if post %}Edit Post{% else %}Create New Post{% endif %} - Forum{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .form-card {
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .form-header {
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 2px solid #E5E7EB;
    }

    .guidelines-box {
        background: #FEF3C7;
        border-left: 4px solid #F59E0B;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
    }

    .required {
        color: #EF4444;
    }

    .form-control, .form-select {
        border: 2px solid #E5E7EB;
        border-radius: 8px;
        padding: 12px;
        width: 100%;
        transition: border-color 0.2s;
    }

    .form-control:focus, .form-select:focus {
        border-color: #5568FE;
        box-shadow: 0 0 0 3px rgba(85, 104, 254, 0.1);
        outline: none;
    }

    .is-invalid {
        border-color: #EF4444 !important;
    }

    .is-invalid:focus {
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }

    .tag-checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        padding: 16px;
        border: 2px solid #E5E7EB;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
    }

    .tag-checkbox {
        display: flex;
        align-items: center;
        padding: 8px;
        border-radius: 6px;
        transition: background 0.2s;
    }

    .tag-checkbox:hover {
        background: #F3F4F6;
    }

    .tag-checkbox input[type="checkbox"] {
        margin-right: 8px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .tag-checkbox label {
        cursor: pointer;
        margin: 0;
        flex: 1;
    }

    .character-count {
        text-align: right;
        font-size: 12px;
        color: #6B7280;
        margin-top: 4px;
    }

    .preview-section {
        background: #F9FAFB;
        border-radius: 12px;
        padding: 24px;
        margin-top: 24px;
        display: none;
    }

    .preview-section.active {
        display: block;
    }

    .preview-content {
        background: white;
        border-radius: 8px;
        padding: 20px;
        min-height: 100px;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 24px;
        border-top: 2px solid #E5E7EB;
        margin-top: 32px;
    }

    .error-message {
        color: #EF4444;
        font-size: 14px;
        margin-top: 4px;
        display: block;
    }

    .help-text {
        font-size: 13px;
        color: #6B7280;
        margin-top: 4px;
    }

    /* Validation Error Box */
    .validation-errors {
        background: #FEE2E2;
        border-left: 4px solid #EF4444;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        display: none;
        animation: slideDown 0.3s ease;
    }

    .validation-errors.active {
        display: block;
    }

    .validation-errors h6 {
        color: #991B1B;
        margin-bottom: 12px;
        font-weight: 600;
    }

    .validation-errors ul {
        margin: 0;
        padding-left: 20px;
        color: #991B1B;
    }

    .validation-errors li {
        margin-bottom: 6px;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="form-container">
        <!-- Back Button -->
        <div class="mb-3">
            <a href="{% url 'forum:forum_home' %}" class="btn btn-outline-secondary btn-sm">
                <i class='bx bx-arrow-back'></i> Back to Forum
            </a>
        </div>

        <div class="form-card">
            <!-- Form Header -->
            <div class="form-header">
                <h2>
                    <i class='bx bx-edit-alt'></i>
                    {% if post %}Edit Your Post{% else %}Create New Post{% endif %}
                </h2>
                <p class="text-muted mb-0">Share your question, knowledge, or start a discussion</p>
            </div>

            <!-- Guidelines -->
            <div class="guidelines-box">
                <h6><i class='bx bx-info-circle'></i> Posting Guidelines</h6>
                <ul>
                    <li>Be clear and specific in your title (minimum 10 characters)</li>
                    <li>Provide context and details in your content (minimum 20 characters)</li>
                    <li>Select appropriate category and tags</li>
                    <li>Be respectful and constructive</li>
                </ul>
            </div>

            <!-- Validation Errors (Client-side) -->
            <div class="validation-errors" id="validation-errors">
                <h6><i class='bx bx-error'></i> Please correct the following errors:</h6>
                <ul id="validation-error-list"></ul>
            </div>

            <!-- Server-side Error Summary -->
            {% if form.errors or form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                <strong><i class='bx bx-error'></i> Please correct the following errors:</strong>
                {% if form.non_field_errors %}
                    <ul class="mb-0 mt-2">
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                {% if form.errors %}
                    <ul class="mb-0 mt-2">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
            {% endif %}

            <!-- Form -->
            <form method="post" id="post-form">
                {% csrf_token %}

                <!-- Post Type -->
                <div class="form-group">
                    <label class="form-label" for="id_post_type">
                        Post Type <span class="required">*</span>
                    </label>
                    <select name="post_type" id="id_post_type" class="form-select" required>
                        <option value="">Select post type...</option>
                        <option value="question" {% if form.post_type.value == 'question' %}selected{% endif %}>Question</option>
                        <option value="discussion" {% if form.post_type.value == 'discussion' %}selected{% endif %}>Discussion</option>
                        <option value="help" {% if form.post_type.value == 'help' %}selected{% endif %}>Help Request</option>
                        <option value="tutorial" {% if form.post_type.value == 'tutorial' %}selected{% endif %}>Tutorial</option>
                        <option value="showcase" {% if form.post_type.value == 'showcase' %}selected{% endif %}>Project Showcase</option>
                        <option value="announcement" {% if form.post_type.value == 'announcement' %}selected{% endif %}>Announcement</option>
                    </select>
                    <span class="error-message" id="error-post_type"></span>
                </div>

                <!-- Title -->
                <div class="form-group">
                    <label class="form-label" for="id_title">
                        Title <span class="required">*</span>
                    </label>
                    <input type="text" 
                           name="title" 
                           id="id_title"
                           class="form-control"
                           value="{{ form.title.value|default:'' }}"
                           placeholder="Enter your question or discussion topic..."
                           maxlength="200"
                           required>
                    <div class="character-count" id="title-count">0 / 200</div>
                    <small class="help-text">Make it descriptive and specific (minimum 10 characters)</small>
                    <span class="error-message" id="error-title"></span>
                </div>

                <!-- Category -->
                <div class="form-group">
                    <label class="form-label" for="id_category">
                        Category <span class="required">*</span>
                    </label>
                    <select name="category" id="id_category" class="form-select" required>
                        <option value="">Select a category...</option>
                        {% for category in form.category.field.queryset %}
                            <option value="{{ category.id }}" {% if form.category.value|stringformat:"s" == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="help-text">Select the most relevant category</small>
                    <span class="error-message" id="error-category"></span>
                </div>

                <!-- Content -->
                <div class="form-group">
                    <label class="form-label" for="id_content">
                        Content <span class="required">*</span>
                    </label>
                    <textarea name="content" 
                              id="id_content"
                              class="form-control"
                              rows="12"
                              placeholder="Provide details, context, what you've tried, and any relevant information..."
                              required>{{ form.content.value|default:'' }}</textarea>
                    <div class="character-count" id="content-count">0 / 5000</div>
                    <small class="help-text">Minimum 20 characters. Be detailed and clear.</small>
                    <span class="error-message" id="error-content"></span>
                </div>

                <!-- Programming Languages -->
                <div class="form-group">
                    <label class="form-label" for="id_programming_languages">
                        Technologies / Programming Languages
                    </label>
                    <input type="text" 
                           name="programming_languages" 
                           id="id_programming_languages"
                           class="form-control"
                           value="{{ form.programming_languages.value|default:'' }}"
                           placeholder="e.g., Python, Django, JavaScript, React">
                    <small class="help-text">Comma-separated list of technologies</small>
                </div>

                <!-- Tags -->
                <div class="form-group">
                    <label class="form-label">
                        Tags (Select up to 5)
                    </label>
                    <div class="tag-checkbox-group">
                        {% for choice in form.tags %}
                        <div class="tag-checkbox">
                            {{ choice.tag }}
                            <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <small class="help-text">Select relevant tags to help others find your post</small>
                    <span class="error-message" id="error-tags" style="display: none;">
                        Maximum 5 tags allowed
                    </span>
                </div>

                <!-- Preview Section -->
                <div class="preview-section" id="preview-section">
                    <h5 class="mb-3"><i class='bx bx-show'></i> Preview</h5>
                    <div class="preview-content" id="preview-content"></div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-outline-secondary" id="preview-btn">
                        <i class='bx bx-show'></i> Show Preview
                    </button>
                    <a href="{% url 'forum:forum_home' %}" class="btn btn-outline-secondary">
                        <i class='bx bx-x'></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <i class='bx bx-send'></i>
                        {% if post %}Update Post{% else %}Create Post{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Forum post form initialized');

    // Get form elements
    const form = document.getElementById('post-form');
    const submitBtn = document.getElementById('submit-btn');
    const titleInput = document.getElementById('id_title');
    const contentTextarea = document.getElementById('id_content');
    const categorySelect = document.getElementById('id_category');
    const postTypeSelect = document.getElementById('id_post_type');
    const titleCount = document.getElementById('title-count');
    const contentCount = document.getElementById('content-count');
    const previewBtn = document.getElementById('preview-btn');
    const previewSection = document.getElementById('preview-section');
    const previewContent = document.getElementById('preview-content');
    const validationErrorsBox = document.getElementById('validation-errors');
    const validationErrorsList = document.getElementById('validation-error-list');
    let previewShown = false;

    // Character counters
    function updateCharCount(input, countElement, maxLength) {
        const length = input.value.length;
        countElement.textContent = `${length} / ${maxLength}`;
        
        countElement.classList.remove('text-warning', 'text-danger');
        if (length > maxLength * 0.9) {
            countElement.classList.add('text-warning');
        }
        if (length >= maxLength) {
            countElement.classList.add('text-danger');
        }
    }

    if (titleInput && titleCount) {
        titleInput.addEventListener('input', function() {
            updateCharCount(this, titleCount, 200);
            clearFieldError('title');
        });
        updateCharCount(titleInput, titleCount, 200);
    }

    if (contentTextarea && contentCount) {
        contentTextarea.addEventListener('input', function() {
            updateCharCount(this, contentCount, 5000);
            clearFieldError('content');
        });
        updateCharCount(contentTextarea, contentCount, 5000);
    }

    // Clear field error on change
    postTypeSelect.addEventListener('change', () => clearFieldError('post_type'));
    categorySelect.addEventListener('change', () => clearFieldError('category'));

    // Tag limit enforcement
    const tagCheckboxes = document.querySelectorAll('.tag-checkbox input[type="checkbox"]');
    const tagWarning = document.getElementById('error-tags');
    const MAX_TAGS = 5;

    function updateTagLimit() {
        const checkedCount = Array.from(tagCheckboxes).filter(cb => cb.checked).length;
        
        if (checkedCount >= MAX_TAGS) {
            tagWarning.style.display = 'block';
            tagCheckboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.disabled = true;
                    cb.parentElement.style.opacity = '0.5';
                }
            });
        } else {
            tagWarning.style.display = 'none';
            tagCheckboxes.forEach(cb => {
                cb.disabled = false;
                cb.parentElement.style.opacity = '1';
            });
        }
    }

    tagCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateTagLimit);
    });
    updateTagLimit();

    // Preview functionality
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            if (!previewShown) {
                const title = titleInput.value.trim();
                const content = contentTextarea.value.trim();
                
                if (!title || !content) {
                    showValidationErrors(['Please fill in the title and content to preview']);
                    return;
                }

                let previewHTML = `<h4>${escapeHtml(title)}</h4><hr>`;
                previewHTML += `<div style="white-space: pre-wrap;">${escapeHtml(content)}</div>`;
                
                const langs = document.getElementById('id_programming_languages').value;
                if (langs.trim()) {
                    previewHTML += `<hr><div class="mt-3"><small><strong>Technologies:</strong> ${escapeHtml(langs)}</small></div>`;
                }

                previewContent.innerHTML = previewHTML;
                previewSection.classList.add('active');
                previewBtn.innerHTML = '<i class="bx bx-hide"></i> Hide Preview';
                previewShown = true;
                
                previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                previewSection.classList.remove('active');
                previewBtn.innerHTML = '<i class="bx bx-show"></i> Show Preview';
                previewShown = false;
            }
        });
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Show validation errors
    function showValidationErrors(errors) {
        validationErrorsList.innerHTML = '';
        errors.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            validationErrorsList.appendChild(li);
        });
        validationErrorsBox.classList.add('active');
        validationErrorsBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Clear all validation errors
    function clearAllErrors() {
        validationErrorsBox.classList.remove('active');
        document.querySelectorAll('.error-message').forEach(el => {
            el.textContent = '';
            el.style.display = 'none';
        });
        document.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });
    }

    // Clear specific field error
    function clearFieldError(fieldName) {
        const errorElement = document.getElementById(`error-${fieldName}`);
        if (errorElement) {
            errorElement.textContent = '';
            errorElement.style.display = 'none';
        }
        const fieldElement = document.getElementById(`id_${fieldName}`);
        if (fieldElement) {
            fieldElement.classList.remove('is-invalid');
        }
    }

    // Show field error
    function showFieldError(fieldName, message) {
        const errorElement = document.getElementById(`error-${fieldName}`);
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        const fieldElement = document.getElementById(`id_${fieldName}`);
        if (fieldElement) {
            fieldElement.classList.add('is-invalid');
        }
    }

    // Form validation
    function validateForm() {
        clearAllErrors();
        let errors = [];
        let isValid = true;

        // Post Type
        const postType = postTypeSelect.value;
        if (!postType) {
            errors.push('Please select a post type');
            showFieldError('post_type', 'Required field');
            isValid = false;
        }

        // Title
        const title = titleInput.value.trim();
        if (title.length < 10) {
            errors.push('Title must be at least 10 characters long');
            showFieldError('title', 'Minimum 10 characters required');
            isValid = false;
        }

        // Category
        const category = categorySelect.value;
        if (!category) {
            errors.push('Please select a category');
            showFieldError('category', 'Required field');
            isValid = false;
        }

        // Content
        const content = contentTextarea.value.trim();
        if (content.length < 20) {
            errors.push('Content must be at least 20 characters long');
            showFieldError('content', 'Minimum 20 characters required');
            isValid = false;
        }

        if (!isValid) {
            showValidationErrors(errors);
        }

        return isValid;
    }

    // Form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('Form submit triggered');
            
            // Validate form
            if (!validateForm()) {
                e.preventDefault();
                console.log('Form validation failed');
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bx bx-send"></i> {% if post %}Update Post{% else %}Create Post{% endif %}';
                
                return false;
            }

            // Disable submit button to prevent double submission
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bx bx-loader bx-spin"></i> Submitting...';
            
            console.log('Form validation passed, submitting...');
        });
    }

    console.log('Form setup complete');
});
</script>
{% endblock %}