<!-- File: templates/dashboard/admin/home_enhanced.html -->

{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Admin Dashboard - PrimeTime{% endblock %}

{% block dashboard_content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="dashboard-title">
                    <i class='bx bxs-dashboard'></i> Admin Dashboard
                </h1>
                <p class="dashboard-subtitle">
                    Welcome back, {{ user.display_name }}! Here's what's happening today.
                </p>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-outline-primary me-2" onclick="refreshDashboard()">
                    <i class='bx bx-refresh'></i> Refresh
                </button>
                <button class="btn btn-primary" onclick="exportReport()">
                    <i class='bx bx-download'></i> Export Report
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card stat-primary">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="total-users">{{ total_users }}</div>
                        <div class="small text-muted">
                            {{ students_count }} Students • {{ supervisors_count }} Supervisors
                        </div>
                        <span class="stat-change positive">
                            <i class='bx bx-up-arrow-alt'></i> +{{ recent_users.count }} this week
                        </span>
                    </div>
                    <div class="stat-icon primary-icon">
                        <i class='bx bx-user-circle'></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card stat-warning">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Pending Actions</div>
                        <div class="stat-value" id="pending-users">{{ pending_users }}</div>
                        <div class="small text-muted">
                            {{ pending_projects }} Projects • {{ pending_users }} Users
                        </div>
                        {% if pending_users > 0 or pending_projects > 0 %}
                        <span class="stat-change negative">
                            <i class='bx bx-time'></i> Requires attention
                        </span>
                        {% endif %}
                    </div>
                    <div class="stat-icon warning-icon">
                        <i class='bx bx-user-plus'></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card stat-info">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Active Projects</div>
                        <div class="stat-value">{{ in_progress_projects }}</div>
                        <div class="small text-muted">
                            {{ approved_projects }} Approved Total
                        </div>
                        <span class="stat-change positive">
                            <i class='bx bx-trending-up'></i> On track
                        </span>
                    </div>
                    <div class="stat-icon info-icon">
                        <i class='bx bx-folder-open'></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card stat-success">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Completed</div>
                        <div class="stat-value">{{ completed_projects }}</div>
                        <div class="small text-muted">
                            {{ completed_projects|floatformat:0 }}% completion rate
                        </div>
                        <span class="stat-change positive">
                            <i class='bx bx-check-circle'></i> Success rate: 95%
                        </span>
                    </div>
                    <div class="stat-icon success-icon">
                        <i class='bx bx-check-circle'></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class='bx bx-rocket'></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="quick-actions-grid">
                        <a href="{% url 'accounts:create_user' %}" class="quick-action-btn">
                            <i class='bx bx-user-plus'></i>
                            <span>Create User</span>
                        </a>
                        <a href="{% url 'accounts:user_list' %}" class="quick-action-btn">
                            <i class='bx bx-group'></i>
                            <span>Manage Users</span>
                        </a>
                        <a href="{% url 'projects:all_projects' %}" class="quick-action-btn">
                            <i class='bx bx-folder-open'></i>
                            <span>All Projects</span>
                        </a>
                        <a href="{% url 'events:event_create' %}" class="quick-action-btn">
                            <i class='bx bx-calendar'></i>
                            <span>Create Event</span>
                        </a>
                        <a href="{% url 'resources:resource_create' %}" class="quick-action-btn">
                            <i class='bx bx-book'></i>
                            <span>Add Resource</span>
                        </a>
                        <a href="{% url 'analytics:admin_analytics' %}" class="quick-action-btn">
                            <i class='bx bx-stats'></i>
                            <span>Analytics</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Analytics -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class='bx bx-line-chart'></i> System Activity</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="updateChart('week')">Week</button>
                        <button type="button" class="btn btn-outline-primary" onclick="updateChart('month')">Month</button>
                        <button type="button" class="btn btn-outline-primary" onclick="updateChart('year')">Year</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="modern-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class='bx bx-pie-chart-alt-2'></i> User Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container sm">
                        <canvas id="userDistChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class='bx bxs-circle' style="color: var(--primary);"></i> Students</span>
                            <strong>{{ students_count }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class='bx bxs-circle' style="color: var(--info);"></i> Supervisors</span>
                            <strong>{{ supervisors_count }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class='bx bxs-circle' style="color: var(--warning);"></i> Admins</span>
                            <strong>{{ admins_count }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users with Initial Passwords -->
    {% if users_with_passwords %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class='bx bx-lock-alt'></i> Users with Initial Passwords
                    </h5>
                    <span class="badge bg-warning">{{ users_with_passwords.count }}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Initial Password</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users_with_passwords|slice:":10" %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class='bx bx-user text-white'></i>
                                                </div>
                                            </div>
                                            <div>
                                                <strong>{{ user.display_name }}</strong><br>
                                                <small class="text-muted">{{ user.user_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-secondary">{{ user.get_role_display }}</span></td>
                                    <td>{{ user.department|default:"-" }}</td>
                                    <td>
                                        <code class="bg-warning bg-opacity-10 px-2 py-1 rounded">{{ user.initial_password }}</code>
                                        <button class="btn btn-sm btn-link" onclick="copyPassword('{{ user.initial_password }}', this)">
                                            <i class='bx bx-copy'></i>
                                        </button>
                                    </td>
                                    <td><small>{{ user.created_at|timesince }} ago</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="sendCredentials('{{ user.email }}')">
                                            <i class='bx bx-send'></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Two Column Layout -->
    <div class="row">
        <!-- Recent Activity -->
        <div class="col-lg-6 mb-4">
            <div class="modern-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class='bx bx-time'></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="activity-timeline">
                        {% if recent_users %}
                            {% for user in recent_users|slice:":5" %}
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class='bx bx-user-plus'></i>
                                </div>
                                <div class="activity-content">
                                    <strong>{{ user.display_name }}</strong> joined as {{ user.get_role_display }}
                                    <div class="activity-time">{{ user.created_at|timesince }} ago</div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class='bx bx-history'></i>
                                <h5>No Recent Activity</h5>
                                <p>Activity will appear here when users join or take actions.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Approvals -->
        <div class="col-lg-6 mb-4">
            <div class="modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class='bx bx-folder'></i> Pending Approvals</h5>
                    <span class="badge bg-danger">{{ pending_projects_list.count }}</span>
                </div>
                <div class="card-body">
                    {% if pending_projects_list %}
                        <div class="list-group list-group-flush">
                            {% for project in pending_projects_list|slice:":5" %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ project.title|truncatechars:40 }}</h6>
                                        <small class="text-muted">
                                            <i class='bx bx-user'></i> {{ project.student.display_name }}
                                            <br>
                                            <i class='bx bx-code-alt'></i> {{ project.programming_languages|truncatechars:30 }}
                                        </small>
                                    </div>
                                    <a href="{% url 'projects:project_review' project.pk %}" class="btn btn-sm btn-primary">
                                        Review
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class='bx bx-check-circle'></i>
                            <h5>All Caught Up!</h5>
                            <p>No projects pending approval.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Activity Chart
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'New Users',
                data: [12, 19, 8, 15, 20, 12, 10],
                borderColor: 'rgb(85, 104, 254)',
                backgroundColor: 'rgba(85, 104, 254, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Project Submissions',
                data: [5, 10, 6, 12, 15, 8, 7],
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // User Distribution Chart
    const distCtx = document.getElementById('userDistChart').getContext('2d');
    new Chart(distCtx, {
        type: 'doughnut',
        data: {
            labels: ['Students', 'Supervisors', 'Admins'],
            datasets: [{
                data: [{{ students_count }}, {{ supervisors_count }}, {{ admins_count }}],
                backgroundColor: [
                    'rgb(85, 104, 254)',
                    'rgb(59, 130, 246)',
                    'rgb(245, 158, 11)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
});

function copyPassword(password, btn) {
    navigator.clipboard.writeText(password).then(() => {
        const icon = btn.querySelector('i');
        icon.className = 'bx bx-check';
        setTimeout(() => icon.className = 'bx bx-copy', 2000);
    });
}

function sendCredentials(email) {
    // Implement AJAX call to send credentials
    alert('Credentials sent to ' + email);
}

function refreshDashboard() {
    location.reload();
}

function exportReport() {
    // Implement export functionality
    alert('Exporting report...');
}

function updateChart(period) {
    // Implement chart update logic
    console.log('Updating chart for period:', period);
}
</script>
{% endblock %}