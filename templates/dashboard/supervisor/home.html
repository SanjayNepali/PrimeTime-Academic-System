<!-- File: templates/dashboard/supervisor/home.html - COMPLETE FIXED VERSION -->

{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Supervisor Dashboard - PrimeTime{% endblock %}

{% block dashboard_content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="dashboard-title">
                    <i class='bx bxs-user-badge'></i> Supervisor Dashboard
                </h1>
                <p class="dashboard-subtitle">
                    Monitor your groups, review submissions, and support students
                </p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-primary me-2" onclick="location.reload()">
                    <i class='bx bx-refresh'></i> Refresh
                </button>
                <a href="{% url 'analytics:supervisor_analytics' %}" class="btn btn-primary">
                    <i class='bx bx-stats'></i> View Analytics
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card stat-primary">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Total Groups</div>
                        <div class="stat-value">{{ total_groups }}</div>
                        <div class="small text-muted">Active groups</div>
                        <span class="stat-change positive">
                            <i class='bx bx-trending-up'></i> All active
                        </span>
                    </div>
                    <div class="stat-icon primary-icon">
                        <i class='bx bx-group'></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card stat-info">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Total Students</div>
                        <div class="stat-value">{{ total_students }}</div>
                        <div class="small text-muted">Under supervision</div>
                    </div>
                    <div class="stat-icon info-icon">
                        <i class='bx bx-user'></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card stat-success">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Avg Progress</div>
                        <div class="stat-value">{{ avg_progress|floatformat:0 }}%</div>
                        <div class="small text-muted">Across all projects</div>
                        {% if avg_progress >= 50 %}
                        <span class="stat-change positive">
                            <i class='bx bx-trending-up'></i> On track
                        </span>
                        {% endif %}
                    </div>
                    <div class="stat-icon success-icon">
                        <i class='bx bx-trending-up'></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stat-card stat-warning">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stat-label">Pending Reviews</div>
                        <div class="stat-value">{{ pending_reviews }}</div>
                        <div class="small text-muted">Need attention</div>
                        {% if pending_reviews > 0 %}
                        <span class="stat-change negative">
                            <i class='bx bx-time'></i> Action required
                        </span>
                        {% endif %}
                    </div>
                    <div class="stat-icon warning-icon">
                        <i class='bx bx-time'></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class='bx bx-rocket'></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="quick-actions-grid">
                        <a href="{% url 'groups:group_list' %}" class="quick-action-btn">
                            <i class='bx bx-group'></i>
                            <span>Manage Groups</span>
                        </a>
                        <a href="{% url 'projects:supervisor_projects' %}" class="quick-action-btn">
                            <i class='bx bx-folder'></i>
                            <span>View Projects</span>
                        </a>
                        <a href="{% url 'analytics:supervisor_analytics' %}" class="quick-action-btn">
                            <i class='bx bx-stats'></i>
                            <span>Analytics</span>
                        </a>
                        <a href="{% url 'chat:chat_home' %}" class="quick-action-btn">
                            <i class='bx bx-chat'></i>
                            <span>Chat</span>
                        </a>
                        <a href="{% url 'forum:forum_home' %}" class="quick-action-btn">
                            <i class='bx bx-message-rounded'></i>
                            <span>Forum</span>
                        </a>
                        <a href="{% url 'resources:resource_list' %}" class="quick-action-btn">
                            <i class='bx bx-book'></i>
                            <span>Resources</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Groups -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class='bx bx-group'></i> My Groups</h5>
                    <span class="badge bg-primary">{{ supervised_groups.count }}</span>
                </div>
                <div class="card-body">
                    {% if supervised_groups %}
                        <div class="row">
                            {% for group in supervised_groups %}
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="card border-0 bg-light h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <h6 class="mb-0">{{ group.name }}</h6>
                                            <span class="badge bg-{% if group.is_full %}success{% else %}warning{% endif %}">
                                                {% if group.is_full %}Full{% else %}{{ group.available_slots }} slots{% endif %}
                                            </span>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <small class="text-muted d-block mb-1">Group Size</small>
                                            <div class="progress" style="height: 20px;">
                                                {% widthratio group.student_count group.max_students 100 as capacity_pct %}
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: {{ capacity_pct }}%"
                                                     aria-valuenow="{{ capacity_pct }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    {{ capacity_pct }}%
                                                </div>
                                            </div>
                                            <small class="text-muted">{{ group.student_count }}/{{ group.max_students }} students</small>
                                        </div>

                                        <div class="mb-3">
                                            <small class="text-muted">
                                                <i class='bx bx-calendar'></i> Batch {{ group.batch_year }}
                                            </small>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <a href="{% url 'groups:group_detail' group.pk %}" class="btn btn-sm btn-primary flex-grow-1">
                                                <i class='bx bx-show'></i> View
                                            </a>
                                            <a href="{% url 'chat:chat_home' %}" class="btn btn-sm btn-outline-secondary">
                                                <i class='bx bx-chat'></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class='bx bx-group'></i>
                            <h5>No Groups Assigned</h5>
                            <p>You haven't been assigned to any groups yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="row">
        <!-- Pending Reviews -->
        <div class="col-lg-6 mb-4">
            <div class="modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class='bx bx-time'></i> Pending Reviews</h5>
                    <span class="badge bg-warning">{{ pending_deliverables.count }}</span>
                </div>
                <div class="card-body">
                    {% if pending_deliverables %}
                        <div class="list-group list-group-flush">
                            {% for deliverable in pending_deliverables|slice:":5" %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ deliverable.get_stage_display }}</h6>
                                        <small class="text-muted d-block">
                                            <i class='bx bx-user'></i> {{ deliverable.project.student.display_name }}
                                        </small>
                                        <small class="text-muted">
                                            {{ deliverable.project.title|truncatechars:35 }}
                                        </small>
                                    </div>
                                    <a href="{% url 'projects:supervisor_project_detail' deliverable.project.pk %}" class="btn btn-sm btn-primary">
                                        Review
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if pending_deliverables.count > 5 %}
                        <div class="text-center mt-3">
                            <a href="{% url 'projects:supervisor_projects' %}" class="btn btn-sm btn-outline-primary">
                                View All {{ pending_deliverables.count }}
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            <i class='bx bx-check-circle'></i>
                            <h5>All Caught Up!</h5>
                            <p>No pending reviews at this time.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- High Stress Students Alert -->
        <div class="col-lg-6 mb-4">
            <div class="modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class='bx bx-error'></i> Students Needing Support</h5>
                    <span class="badge bg-danger">{{ high_stress_students|length }}</span>
                </div>
                <div class="card-body">
                    {% if high_stress_students %}
                        <div class="alert alert-warning" role="alert">
                            <i class='bx bx-info-circle'></i> 
                            Some students may be experiencing high stress. Consider reaching out.
                        </div>
                        <div class="list-group list-group-flush">
                            {% for student in high_stress_students|slice:":5" %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ student.display_name }}</h6>
                                        <small class="text-muted">
                                            <i class='bx bx-heart'></i> 
                                            {{ student.stress_level|floatformat:0 }}%
                                            <span class="badge bg-{% if student.stress_level < 60 %}warning{% else %}danger{% endif %}">
                                                {% if student.stress_level < 60 %}Moderate{% else %}High{% endif %}
                                            </span>
                                        </small>
                                    </div>
                                    <a href="{% url 'analytics:supervisor_view_student' student.pk %}" class="btn btn-sm btn-outline-primary">
                                        View
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class='bx bx-happy'></i>
                            <h5>All Students Doing Well</h5>
                            <p>No students showing high stress levels.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Student Progress Table -->
    <div class="row">
        <div class="col-12">
            <div class="modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class='bx bx-bar-chart-alt-2'></i> Student Progress Overview</h5>
                </div>
                <div class="card-body">
                    {% if supervised_students %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Project</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Stress</th>
                                        <th>Last Activity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in supervised_students|slice:":10" %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm me-2">
                                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                        <i class='bx bx-user text-white'></i>
                                                    </div>
                                                </div>
                                                <div>
                                                    <strong>{{ student.display_name }}</strong><br>
                                                    <small class="text-muted">{{ student.user_id }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if student.projects.exists %}
                                                {{ student.projects.first.title|truncatechars:25 }}
                                            {% else %}
                                                <span class="text-muted">No project</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress" style="width: 100px; height: 8px;">
                                                    <div class="progress-bar" role="progressbar" 
                                                         style="width: {% if student.projects.exists %}{{ student.projects.first.progress_percentage }}{% else %}0{% endif %}%">
                                                    </div>
                                                </div>
                                                <span class="ms-2 small">{% if student.projects.exists %}{{ student.projects.first.progress_percentage }}%{% else %}0%{% endif %}</span>
                                            </div>
                                        </td>
                                        <td>
                                            {% if student.projects.exists %}
                                                <span class="badge bg-{% if student.projects.first.status == 'in_progress' %}info{% elif student.projects.first.status == 'completed' %}success{% else %}secondary{% endif %}">
                                                    {{ student.projects.first.get_status_display }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">No Project</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if student.stress_level < 40 %}success{% elif student.stress_level < 70 %}warning{% else %}danger{% endif %}">
                                                {{ student.stress_level|floatformat:0 }}%
                                            </span>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {% if student.projects.exists and student.projects.first.updated_at %}
                                                    {{ student.projects.first.updated_at|timesince }} ago
                                                {% else %}
                                                    Never
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {% if student.projects.exists %}
                                                <a href="{% url 'projects:supervisor_project_detail' student.projects.first.pk %}" 
                                                   class="btn btn-outline-primary" title="View Details">
                                                    <i class='bx bx-show'></i>
                                                </a>
                                                {% endif %}
                                                <a href="{% url 'chat:user_chat' student.pk %}" class="btn btn-outline-secondary" title="Send Message">
                                                    <i class='bx bx-message'></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if supervised_students.count > 10 %}
                        <div class="text-center mt-3">
                            <a href="{% url 'analytics:supervisor_analytics' %}" class="btn btn-outline-primary">
                                View All {{ supervised_students.count }} Students
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            <i class='bx bx-user'></i>
                            <h5>No Students Assigned</h5>
                            <p>You don't have any students to supervise yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.empty-state {
    text-align: center;
    padding: 40px 20px;
}

.empty-state i {
    font-size: 48px;
    color: #d1d5db;
    margin-bottom: 12px;
}

.empty-state h5 {
    margin-bottom: 8px;
    color: #374151;
}

.empty-state p {
    color: #6b7280;
    margin: 0;
}
</style>
{% endblock %}