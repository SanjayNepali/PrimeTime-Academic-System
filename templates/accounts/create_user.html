<!-- File: Desktop/Prime/templates/accounts/create_user.html -->

{% extends 'base.html' %}

{% block title %}Create User - PrimeTime{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card modern-card">
                <div class="card-header">
                    <h4><i class='bx bx-user-plus'></i> Create New User</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="user-creation-form">
                        {% csrf_token %}
                        
                        <!-- Manual Creation Option -->
                        <div class="alert alert-info mb-4">
                            <i class='bx bx-info-circle'></i>
                            <strong>Two ways to create users:</strong><br>
                            1. Use University ID lookup (recommended) - auto-fills user details<br>
                            2. Or <a href="#" id="manual-toggle">fill details manually</a>
                        </div>
                        
                        <!-- University ID Lookup -->
                        <div class="form-group mb-4">
                            <label class="form-label">University ID</label>
                            <div class="input-group">
                                {{ form.user_id }}
                                <button type="button" class="btn btn-secondary" id="lookup-btn">
                                    <i class='bx bx-search'></i> Lookup
                                </button>
                            </div>
                            <small class="text-muted">Enter the user's university ID to auto-fetch details</small>
                            {% if form.user_id.errors %}
                                <div class="text-danger small mt-1">{{ form.user_id.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- User Details Section -->
                        <div id="user-details" style="display: none;">
                            <div class="alert alert-success mb-3">
                                <i class='bx bx-check-circle'></i> User details fetched from university database
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Full Name</label>
                                    {{ form.full_name }}
                                    {% if form.full_name.errors %}
                                        <div class="text-danger small mt-1">{{ form.full_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <div class="text-danger small mt-1">{{ form.email.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Department</label>
                                    {{ form.department }}
                                    {% if form.department.errors %}
                                        <div class="text-danger small mt-1">{{ form.department.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Role</label>
                                    {{ form.role }}
                                    {% if form.role.errors %}
                                        <div class="text-danger small mt-1">{{ form.role.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Additional Fields for Manual Creation -->
                                <div class="col-md-6 mb-3 manual-field" style="display: none;">
                                    <label class="form-label">Phone Number</label>
                                    {{ form.phone }}
                                    {% if form.phone.errors %}
                                        <div class="text-danger small mt-1">{{ form.phone.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3 manual-field" style="display: none;">
                                    <label class="form-label">Batch Year</label>
                                    {{ form.batch_year }}
                                    {% if form.batch_year.errors %}
                                        <div class="text-danger small mt-1">{{ form.batch_year.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class='bx bx-check'></i> Create User Account
                                </button>
                                <button type="button" class="btn btn-secondary" id="reset-form">
                                    <i class='bx bx-reset'></i> Reset
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Success Message -->
                    <div id="success-message" class="alert alert-success mt-4" style="display: none;">
                        <h5><i class='bx bx-check-circle'></i> User Created Successfully!</h5>
                        <div class="user-details-grid mt-3">
                            <div class="detail-item">
                                <strong>Username:</strong> <span id="created-username"></span>
                            </div>
                            <div class="detail-item">
                                <strong>Email:</strong> <span id="created-email"></span>
                            </div>
                            <div class="detail-item">
                                <strong>Role:</strong> <span id="created-role"></span>
                            </div>
                            <div class="detail-item">
                                <strong>Initial Password:</strong> 
                                <span id="initial-password" class="font-monospace bg-warning px-2 py-1 rounded"></span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="copyPassword()">
                                    <i class='bx bx-copy'></i> Copy
                                </button>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class='bx bx-info-circle'></i>
                            This password is visible until the user logs in for the first time.
                        </small>
                        <div class="mt-3">
                            <a href="{% url 'accounts:create_user' %}" class="btn btn-sm btn-outline-primary">
                                <i class='bx bx-user-plus'></i> Create Another User
                            </a>
                            <a href="{% url 'accounts:user_list' %}" class="btn btn-sm btn-outline-secondary">
                                <i class='bx bx-list-ul'></i> View All Users
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.user-details-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.5rem;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.manual-field {
    transition: all 0.3s ease;
}

#lookup-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.loading {
    position: relative;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: translateY(-50%) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const lookupBtn = document.getElementById('lookup-btn');
    const userIdInput = document.getElementById('user-id-input');
    const userDetails = document.getElementById('user-details');
    const manualToggle = document.getElementById('manual-toggle');
    const manualFields = document.querySelectorAll('.manual-field');
    const resetBtn = document.getElementById('reset-form');

    // University ID Lookup
    lookupBtn.addEventListener('click', function() {
        const userId = userIdInput.value.trim();
        
        if (!userId) {
            alert('Please enter a University ID');
            return;
        }

        // Show loading state
        lookupBtn.disabled = true;
        lookupBtn.innerHTML = '<i class="bx bx-loader bx-spin"></i> Searching...';

        fetch(`/accounts/lookup-user/?user_id=${encodeURIComponent(userId)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate form fields
                    document.querySelector('[name="full_name"]').value = data.data.full_name || '';
                    document.querySelector('[name="email"]').value = data.data.email || '';
                    document.querySelector('[name="department"]').value = data.data.department || '';
                    document.querySelector('[name="role"]').value = data.data.role || '';
                    
                    // Show user details section
                    userDetails.style.display = 'block';
                    
                    // Hide manual fields
                    manualFields.forEach(field => field.style.display = 'none');
                } else {
                    alert(data.error || 'User not found in university database');
                    // Show manual creation option
                    manualToggle.click();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error looking up user. Please check your connection and try again.');
            })
            .finally(() => {
                // Reset button state
                lookupBtn.disabled = false;
                lookupBtn.innerHTML = '<i class="bx bx-search"></i> Lookup';
            });
    });

    // Manual creation toggle
    manualToggle.addEventListener('click', function(e) {
        e.preventDefault();
        userDetails.style.display = 'block';
        manualFields.forEach(field => field.style.display = 'block');
        
        // Clear auto-filled data
        document.querySelector('[name="full_name"]').value = '';
        document.querySelector('[name="email"]').value = '';
        document.querySelector('[name="department"]').value = '';
        document.querySelector('[name="role"]').value = '';
        
        this.style.display = 'none';
    });

    // Reset form
    resetBtn.addEventListener('click', function() {
        document.getElementById('user-creation-form').reset();
        userDetails.style.display = 'none';
        manualFields.forEach(field => field.style.display = 'none');
        manualToggle.style.display = 'inline';
        userIdInput.focus();
    });

    // Auto-focus on user ID input
    userIdInput.focus();
});

function copyPassword() {
    const password = document.getElementById('initial-password').textContent;
    navigator.clipboard.writeText(password).then(() => {
        // Show temporary feedback
        const btn = event.target;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bx bx-check"></i> Copied!';
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
        }, 2000);
    }).catch(err => {
        alert('Failed to copy password: ' + err);
    });
}

// Handle form submission success (if using AJAX)
function showSuccessMessage(userData) {
    document.getElementById('created-username').textContent = userData.username;
    document.getElementById('created-email').textContent = userData.email;
    document.getElementById('created-role').textContent = userData.role;
    document.getElementById('initial-password').textContent = userData.initial_password;
    
    document.getElementById('user-creation-form').style.display = 'none';
    document.getElementById('success-message').style.display = 'block';
}
</script>
{% endblock %}