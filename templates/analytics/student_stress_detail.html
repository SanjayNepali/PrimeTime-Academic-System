<!-- File: templates/analytics/student_stress_detail.html -->

{% extends 'base.html' %}
{% load static %}

{% block title %}Stress Analysis - {{ student.display_name }}{% endblock %}

{% block extra_css %}
<style>
    .stress-dashboard {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }
    
    .stress-gauge {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto;
    }
    
    .gauge-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(
            #10B981 0% 30%,
            #F59E0B 30% 60%,
            #EF4444 60% 80%,
            #DC2626 80% 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .gauge-inner {
        width: 160px;
        height: 160px;
        background: white;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .gauge-value {
        font-size: 48px;
        font-weight: 700;
        line-height: 1;
    }
    
    .gauge-label {
        font-size: 14px;
        color: #6B7280;
        margin-top: 4px;
    }
    
    .factor-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        border-left: 4px solid #5568FE;
    }
    
    .factor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .factor-name {
        font-weight: 600;
        color: #1A1D26;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .factor-score {
        font-size: 20px;
        font-weight: 700;
        color: #5568FE;
    }
    
    .factor-bar {
        height: 8px;
        background: #F3F4F6;
        border-radius: 4px;
        overflow: hidden;
        margin: 8px 0;
    }
    
    .factor-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    .fill-low { background: linear-gradient(90deg, #10B981, #059669); }
    .fill-moderate { background: linear-gradient(90deg, #F59E0B, #D97706); }
    .fill-high { background: linear-gradient(90deg, #EF4444, #DC2626); }
    
    .factor-description {
        font-size: 13px;
        color: #6B7280;
        margin-top: 8px;
    }
    
    .recommendation-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
    }
    
    .recommendation-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .recommendation-icon {
        width: 48px;
        height: 48px;
        background: rgba(255,255,255,0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    
    .recommendation-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .recommendation-list li {
        padding: 12px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    
    .recommendation-list li i {
        font-size: 20px;
        margin-top: 2px;
    }
    
    .timeline {
        position: relative;
        padding-left: 40px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #E5E7EB;
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 24px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -34px;
        top: 4px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        border: 3px solid #5568FE;
    }
    
    .timeline-date {
        font-size: 12px;
        color: #6B7280;
        margin-bottom: 4px;
    }
    
    .timeline-content {
        background: white;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #E5E7EB;
    }
    
    .intervention-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
    }
    
    .action-btn {
        flex: 1;
        padding: 14px 20px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
    }
    
    .action-primary {
        background: #5568FE;
        color: white;
    }
    
    .action-primary:hover {
        background: #4054E0;
        transform: translateY(-2px);
    }
    
    .action-secondary {
        background: #F3F4F6;
        color: #1A1D26;
    }
    
    .action-secondary:hover {
        background: #E5E7EB;
    }
    
    .alert-info-box {
        background: #DBEAFE;
        border-left: 4px solid #3B82F6;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
    }
    
    .alert-info-box h6 {
        color: #1E40AF;
        margin-bottom: 8px;
    }
    
    .alert-info-box p {
        color: #1E3A8A;
        margin: 0;
        font-size: 14px;
    }

    @media (max-width: 768px) {
        .stress-dashboard {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class='bx bx-brain'></i> Stress Analysis: {{ student.display_name }}
            </h2>
            <p class="text-muted">AI-powered mental health insights and recommendations</p>
        </div>
        <a href="{% url 'analytics:supervisor_analytics' %}" class="btn btn-secondary">
            <i class='bx bx-arrow-back'></i> Back to Dashboard
        </a>
    </div>

    {% if latest_stress %}
    <!-- Alert Box for Critical Stress -->
    {% if latest_stress.level >= 80 %}
    <div class="alert-info-box" style="background: #FEE2E2; border-left-color: #DC2626;">
        <h6 style="color: #991B1B;"><i class='bx bx-error-circle'></i> Critical Stress Level Detected</h6>
        <p style="color: #7F1D1D;">This student requires immediate attention. Consider scheduling an urgent meeting or involving student services.</p>
    </div>
    {% elif latest_stress.level >= 70 %}
    <div class="alert-info-box" style="background: #FEF3C7; border-left-color: #F59E0B;">
        <h6 style="color: #92400E;"><i class='bx bx-error'></i> High Stress Level</h6>
        <p style="color: #78350F;">This student is showing signs of elevated stress. Early intervention recommended.</p>
    </div>
    {% endif %}

    <!-- Main Dashboard -->
    <div class="stress-dashboard">
        <!-- Left Column: Stress Gauge and Factors -->
        <div>
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="mb-4">Current Stress Level</h5>
                    <div class="stress-gauge">
                        <div class="gauge-circle">
                            <div class="gauge-inner">
                                <div class="gauge-value" style="color: {% if latest_stress.level >= 80 %}#DC2626{% elif latest_stress.level >= 60 %}#EF4444{% elif latest_stress.level >= 40 %}#F59E0B{% else %}#10B981{% endif %};">
                                    {{ latest_stress.level|floatformat:0 }}%
                                </div>
                                <div class="gauge-label">{{ latest_stress.stress_category }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <small class="text-muted">Last calculated: {{ latest_stress.timestamp|timesince }} ago</small>
                    </div>
                </div>
            </div>

            <!-- Contributing Factors -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class='bx bx-analyse'></i> Contributing Factors
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Chat Sentiment -->
                    <div class="factor-card">
                        <div class="factor-header">
                            <div class="factor-name">
                                <i class='bx bx-message-dots'></i>
                                Chat Sentiment
                            </div>
                            <div class="factor-score">{{ latest_stress.chat_sentiment_score|floatformat:2 }}</div>
                        </div>
                        <div class="factor-bar">
                            <div class="factor-fill fill-{% if latest_stress.chat_sentiment_score < -0.3 %}high{% elif latest_stress.chat_sentiment_score > 0.3 %}low{% else %}moderate{% endif %}" 
                                 style="width: {{ latest_stress.chat_sentiment_score|add:1|mul:50 }}%;"></div>
                        </div>
                        <div class="factor-description">
                            {% if latest_stress.chat_sentiment_score < -0.3 %}
                            Negative sentiment detected in recent communications
                            {% elif latest_stress.chat_sentiment_score > 0.3 %}
                            Positive and upbeat communication style
                            {% else %}
                            Neutral sentiment in communications
                            {% endif %}
                        </div>
                    </div>

                    <!-- Deadline Pressure -->
                    <div class="factor-card">
                        <div class="factor-header">
                            <div class="factor-name">
                                <i class='bx bx-time'></i>
                                Deadline Pressure
                            </div>
                            <div class="factor-score">{{ latest_stress.deadline_pressure|floatformat:0 }}%</div>
                        </div>
                        <div class="factor-bar">
                            <div class="factor-fill fill-{% if latest_stress.deadline_pressure >= 70 %}high{% elif latest_stress.deadline_pressure >= 40 %}moderate{% else %}low{% endif %}" 
                                 style="width: {{ latest_stress.deadline_pressure }}%;"></div>
                        </div>
                        <div class="factor-description">
                            {% if latest_stress.deadline_pressure >= 70 %}
                            Multiple upcoming deadlines causing high pressure
                            {% elif latest_stress.deadline_pressure >= 40 %}
                            Moderate deadline-related stress
                            {% else %}
                            Manageable deadline schedule
                            {% endif %}
                        </div>
                    </div>

                    <!-- Workload -->
                    <div class="factor-card">
                        <div class="factor-header">
                            <div class="factor-name">
                                <i class='bx bx-briefcase'></i>
                                Workload Assessment
                            </div>
                            <div class="factor-score">{{ latest_stress.workload_score|floatformat:0 }}%</div>
                        </div>
                        <div class="factor-bar">
                            <div class="factor-fill fill-{% if latest_stress.workload_score >= 70 %}high{% elif latest_stress.workload_score >= 40 %}moderate{% else %}low{% endif %}" 
                                 style="width: {{ latest_stress.workload_score }}%;"></div>
                        </div>
                        <div class="factor-description">
                            {% if latest_stress.workload_score >= 70 %}
                            High workload intensity detected
                            {% elif latest_stress.workload_score >= 40 %}
                            Moderate workload levels
                            {% else %}
                            Manageable workload
                            {% endif %}
                        </div>
                    </div>

                    <!-- Social Isolation -->
                    <div class="factor-card">
                        <div class="factor-header">
                            <div class="factor-name">
                                <i class='bx bx-user-circle'></i>
                                Social Engagement
                            </div>
                            <div class="factor-score">{{ latest_stress.social_isolation_score|floatformat:0 }}%</div>
                        </div>
                        <div class="factor-bar">
                            <div class="factor-fill fill-{% if latest_stress.social_isolation_score >= 70 %}high{% elif latest_stress.social_isolation_score >= 40 %}moderate{% else %}low{% endif %}" 
                                 style="width: {{ latest_stress.social_isolation_score }}%;"></div>
                        </div>
                        <div class="factor-description">
                            {% if latest_stress.social_isolation_score >= 70 %}
                            Low social interaction - may need support
                            {% elif latest_stress.social_isolation_score >= 40 %}
                            Moderate social engagement
                            {% else %}
                            Active social participation
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Recommendations and Trend -->
        <div>
            <!-- AI Recommendations -->
            <div class="recommendation-card">
                <div class="recommendation-header">
                    <div class="recommendation-icon">
                        <i class='bx bx-bulb'></i>
                    </div>
                    <div>
                        <h5 class="mb-0">AI Recommendations</h5>
                        <small style="opacity: 0.9;">Suggested interventions</small>
                    </div>
                </div>
                <ul class="recommendation-list">
                    {% if latest_stress.level >= 70 %}
                    <li>
                        <i class='bx bx-calendar'></i>
                        <span>Schedule an urgent check-in meeting within 48 hours</span>
                    </li>
                    <li>
                        <i class='bx bx-message-detail'></i>
                        <span>Send supportive message acknowledging their hard work</span>
                    </li>
                    {% endif %}
                    
                    {% if latest_stress.deadline_pressure >= 60 %}
                    <li>
                        <i class='bx bx-time'></i>
                        <span>Review deadline schedule and consider extensions if appropriate</span>
                    </li>
                    {% endif %}
                    
                    {% if latest_stress.workload_score >= 60 %}
                    <li>
                        <i class='bx bx-list-check'></i>
                        <span>Help prioritize tasks and break down overwhelming deliverables</span>
                    </li>
                    {% endif %}
                    
                    {% if latest_stress.social_isolation_score >= 60 %}
                    <li>
                        <i class='bx bx-group'></i>
                        <span>Encourage group collaboration and peer support activities</span>
                    </li>
                    {% endif %}
                    
                    <li>
                        <i class='bx bx-heart'></i>
                        <span>Remind about campus mental health resources</span>
                    </li>
                </ul>
            </div>

            <!-- Stress Trend -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class='bx bx-trending-up'></i> Stress Trend
                        <span class="badge bg-{% if stress_trend.trend == 'increasing' %}danger{% elif stress_trend.trend == 'decreasing' %}success{% else %}secondary{% endif %} ms-2">
                            {{ stress_trend.trend|title }}
                        </span>
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="stressTrendChart" style="max-height: 200px;"></canvas>
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            Average: {{ stress_trend.average|floatformat:1 }}% | 
                            Current: {{ stress_trend.current|floatformat:1 }}%
                        </small>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class='bx bx-lightning'></i> Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="intervention-actions">
                        <a href="{% url 'analytics:supervisor_add_feedback' student.id %}" class="action-btn action-primary">
                            <i class='bx bx-message-square-add'></i>
                            Add Feedback
                        </a>
                    </div>
                    <div class="intervention-actions">
                        <a href="{% url 'analytics:supervisor_view_student' student.id %}" class="action-btn action-secondary">
                            <i class='bx bx-user'></i>
                            View Full Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stress History Timeline -->
    <div class="card">
        <div class="card-header bg-white">
            <h5 class="mb-0">
                <i class='bx bx-history'></i> Stress History (Last 60 Days)
            </h5>
        </div>
        <div class="card-body">
            {% if stress_history %}
            <div class="timeline">
                {% for stress in stress_history %}
                <div class="timeline-item">
                    <div class="timeline-date">
                        {{ stress.timestamp|date:"M d, Y - H:i" }}
                    </div>
                    <div class="timeline-content">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Stress Level: {{ stress.level|floatformat:1 }}%</strong>
                                <span class="badge bg-{% if stress.level >= 80 %}danger{% elif stress.level >= 60 %}warning{% else %}success{% endif %} ms-2">
                                    {{ stress.stress_category }}
                                </span>
                            </div>
                            <small class="text-muted">{{ stress.project_phase|title }} Phase</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class='bx bx-chart' style="font-size: 64px; color: #D1D5DB;"></i>
                <p class="text-muted mt-3">No historical stress data available</p>
            </div>
            {% endif %}
        </div>
    </div>

    {% else %}
    <!-- No Stress Data Available -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class='bx bx-brain' style="font-size: 64px; color: #D1D5DB;"></i>
            <h4 class="mt-3 text-muted">No Stress Data Available</h4>
            <p class="text-muted">Run stress analysis to generate insights for this student.</p>
            <button class="btn btn-primary mt-3" onclick="runStressAnalysis()">
                <i class='bx bx-refresh'></i> Run Stress Analysis
            </button>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
{% if stress_trend.records %}
// Stress Trend Chart
const trendCtx = document.getElementById('stressTrendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: [
            {% for record in stress_trend.records %}
            '{{ record.calculated_at|date:"M d" }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Stress Level',
            data: [
                {% for record in stress_trend.records %}
                {{ record.level|floatformat:1 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#EF4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});
{% endif %}

function runStressAnalysis() {
    // Implement stress analysis trigger
    alert('Running stress analysis for {{ student.display_name }}...');
}
</script>
{% endblock %}