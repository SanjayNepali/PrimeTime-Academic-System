{% extends 'base.html' %}
{% load static %}

{% block title %}Add Feedback - {{ student.display_name }}{% endblock %}

{% block extra_css %}
<style>
    .sentiment-preview {
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
        transition: all 0.3s;
    }
    .sentiment-positive { background: #c6f6d5; border-left: 4px solid #48bb78; }
    .sentiment-neutral { background: #feebc8; border-left: 4px solid #ed8936; }
    .sentiment-negative { background: #fed7d7; border-left: 4px solid #f56565; }
    .character-count {
        font-size: 12px;
        color: #718096;
    }
    .rating-stars {
        font-size: 32px;
        cursor: pointer;
    }
    .rating-stars .star {
        color: #cbd5e0;
        transition: color 0.2s;
    }
    .rating-stars .star.active,
    .rating-stars .star:hover {
        color: #ecc94b;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class='bx bx-note'></i> Add Feedback Entry
                    </h4>
                    <p class="mb-0 mt-1">For: {{ student.display_name }} | Project: {{ project.title }}</p>
                </div>
                <div class="card-body">
                    <form method="post" id="feedbackForm">
                        {% csrf_token %}

                        <!-- Date -->
                        <div class="mb-3">
                            <label for="{{ form.date.id_for_label }}" class="form-label">
                                {{ form.date.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.date }}
                            {% if form.date.errors %}
                            <div class="text-danger">{{ form.date.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Context -->
                        <div class="mb-3">
                            <label for="{{ form.context.id_for_label }}" class="form-label">
                                {{ form.context.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.context }}
                            {% if form.context.errors %}
                            <div class="text-danger">{{ form.context.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                Examples: Weekly review, Mid-semester feedback, Progress check
                            </small>
                        </div>

                        <!-- Remarks with Sentiment Analysis -->
                        <div class="mb-3">
                            <label for="{{ form.remarks.id_for_label }}" class="form-label">
                                {{ form.remarks.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.remarks }}
                            <div class="d-flex justify-content-between">
                                <small class="form-text text-muted">
                                    Detailed feedback will be analyzed for sentiment
                                </small>
                                <span class="character-count">
                                    <span id="charCount">0</span> characters
                                </span>
                            </div>
                            
                            <!-- Real-time Sentiment Preview -->
                            <div id="sentimentPreview" class="sentiment-preview d-none">
                                <div class="d-flex align-items-center">
                                    <i class='bx bx-brain' style="font-size: 24px; margin-right: 10px;"></i>
                                    <div>
                                        <strong>AI Sentiment Analysis:</strong>
                                        <span id="sentimentLabel"></span>
                                        <br>
                                        <small id="sentimentDescription" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>
                            
                            {% if form.remarks.errors %}
                            <div class="text-danger">{{ form.remarks.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Rating -->
                        <div class="mb-3">
                            <label class="form-label">
                                {{ form.rating.label }}
                            </label>
                            <div class="rating-stars" id="ratingStars">
                                <span class="star" data-rating="1">â˜†</span>
                                <span class="star" data-rating="2">â˜†</span>
                                <span class="star" data-rating="3">â˜†</span>
                                <span class="star" data-rating="4">â˜†</span>
                                <span class="star" data-rating="5">â˜†</span>
                            </div>
                            {{ form.rating }}
                            <small class="form-text text-muted">
                                1 = Needs Significant Improvement, 5 = Excellent
                            </small>
                            {% if form.rating.errors %}
                            <div class="text-danger">{{ form.rating.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Action Required -->
                        <div class="mb-3 form-check">
                            {{ form.action_required }}
                            <label class="form-check-label" for="{{ form.action_required.id_for_label }}">
                                {{ form.action_required.label }}
                            </label>
                            <br>
                            <small class="text-muted">{{ form.action_required.help_text }}</small>
                        </div>

                        <!-- Follow-up Required -->
                        <div class="mb-3 form-check">
                            {{ form.follow_up_required }}
                            <label class="form-check-label" for="{{ form.follow_up_required.id_for_label }}">
                                {{ form.follow_up_required.label }}
                            </label>
                            <br>
                            <small class="text-muted">{{ form.follow_up_required.help_text }}</small>
                        </div>

                        <!-- Follow-up Date (conditional) -->
                        <div class="mb-3" id="followUpDateDiv" style="display: none;">
                            <label for="{{ form.follow_up_date.id_for_label }}" class="form-label">
                                {{ form.follow_up_date.label }}
                            </label>
                            {{ form.follow_up_date }}
                            {% if form.follow_up_date.errors %}
                            <div class="text-danger">{{ form.follow_up_date.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Visibility -->
                        <div class="mb-3 form-check">
                            {{ form.is_visible_to_student }}
                            <label class="form-check-label" for="{{ form.is_visible_to_student.id_for_label }}">
                                {{ form.is_visible_to_student.label }}
                            </label>
                            <br>
                            <small class="text-muted">{{ form.is_visible_to_student.help_text }}</small>
                        </div>

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'analytics:supervisor_view_student' student.id %}" class="btn btn-secondary">
                                <i class='bx bx-arrow-back'></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class='bx bx-save'></i> Save Feedback
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const remarksTextarea = document.getElementById('{{ form.remarks.id_for_label }}');
    const charCount = document.getElementById('charCount');
    const sentimentPreview = document.getElementById('sentimentPreview');
    const sentimentLabel = document.getElementById('sentimentLabel');
    const sentimentDescription = document.getElementById('sentimentDescription');
    const followUpCheckbox = document.getElementById('{{ form.follow_up_required.id_for_label }}');
    const followUpDateDiv = document.getElementById('followUpDateDiv');
    const ratingInput = document.getElementById('{{ form.rating.id_for_label }}');
    const ratingStars = document.querySelectorAll('.star');

    // Character count
    remarksTextarea.addEventListener('input', function() {
        const length = this.value.length;
        charCount.textContent = length;
        
        // Simple client-side sentiment analysis
        if (length > 20) {
            analyzeSentiment(this.value);
        } else {
            sentimentPreview.classList.add('d-none');
        }
    });

    // Simple sentiment analysis (client-side approximation)
    function analyzeSentiment(text) {
        const positiveWords = ['good', 'great', 'excellent', 'outstanding', 'impressive', 'progress', 'improved', 'well', 'strong', 'effective'];
        const negativeWords = ['poor', 'weak', 'lacking', 'insufficient', 'struggling', 'behind', 'concerning', 'needs improvement'];
        
        text = text.toLowerCase();
        let positiveCount = 0;
        let negativeCount = 0;
        
        positiveWords.forEach(word => {
            if (text.includes(word)) positiveCount++;
        });
        
        negativeWords.forEach(word => {
            if (text.includes(word)) negativeCount++;
        });
        
        sentimentPreview.classList.remove('d-none', 'sentiment-positive', 'sentiment-neutral', 'sentiment-negative');
        
        if (positiveCount > negativeCount) {
            sentimentPreview.classList.add('sentiment-positive');
            sentimentLabel.textContent = 'Positive ðŸ˜Š';
            sentimentDescription.textContent = 'This feedback appears encouraging and constructive.';
        } else if (negativeCount > positiveCount) {
            sentimentPreview.classList.add('sentiment-negative');
            sentimentLabel.textContent = 'Critical ðŸ˜ž';
            sentimentDescription.textContent = 'This feedback highlights areas needing improvement.';
        } else {
            sentimentPreview.classList.add('sentiment-neutral');
            sentimentLabel.textContent = 'Neutral ðŸ˜';
            sentimentDescription.textContent = 'This feedback is balanced and objective.';
        }
    }

    // Follow-up date visibility
    followUpCheckbox.addEventListener('change', function() {
        followUpDateDiv.style.display = this.checked ? 'block' : 'none';
    });

    // Rating stars
    ratingStars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = this.dataset.rating;
            ratingInput.value = rating;
            updateStars(rating);
        });
        
        star.addEventListener('mouseenter', function() {
            const rating = this.dataset.rating;
            updateStars(rating);
        });
    });

    document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
        const currentRating = ratingInput.value;
        updateStars(currentRating);
    });

    function updateStars(rating) {
        ratingStars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
                star.textContent = 'â˜…';
            } else {
                star.classList.remove('active');
                star.textContent = 'â˜†';
            }
        });
    }

    // Initialize
    charCount.textContent = remarksTextarea.value.length;
    if (followUpCheckbox.checked) {
        followUpDateDiv.style.display = 'block';
    }
    
    // Initialize rating stars
    const initialRating = ratingInput.value;
    if (initialRating) {
        updateStars(initialRating);
    }
});
</script>
{% endblock %}